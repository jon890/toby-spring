## 6. 싱글톤 레지스트리와 오브젝트 스코프 (singleton_registry_and_object_scope package)

- 스프링의 애플리케이션 컨텍스트는 기존에 직접 만들었던 객체 팩토리왛 중요한 차이가 있다
- 어떤 차이점이 있는 것인가?
- 먼저 DaoFactory의 userDao() 메소드를 두 번 호출해서 리턴되는 UserDao 객체를 비교해보자. 이 두개는 같은 객체일까?


- <b>참고 - 객체의 동일성과 동등성 - </b>
    1. 동일성 비교 => == 연산자를 이용해 비교
    2. 동등성 비교 => equals() 메소드를 이용해 비교
    3. 두 개의 객체가 동일하다 => 사실은 하나의 객체만 존재하는 것이고 두 개의 객체 레퍼런스 변수를 갖고 있는 것
    4. 두 개의 객체가 동일하지 않으나 동등하다 => 두 개의 각기 다른 객체가 메모리상에 존재하고, 객체의 동등성 기준에 따라 두 객체의 정보가 동등하다고 판단하는 것일 뿐이다


- 스프링은 여러 번에 걸쳐 빈을 요청하더라도 매번 동일한 객체를 돌려준다!

### 1. 싱글톤 레지스트리로서의 애플리케이션 컨텍스트

- 애플리케이션 컨텍스트는 우리가 만들었던 객체 팩토리와 비슷한 방식으로 동작하는 IoC 컨테이너다
- 그러면서 동시에 싱글톤을 저장하고 관리하는 싱글톤 레지스트리이기도 하다
- 스프링은 기본적으로 별다른 설정을 하지 않으면 내부에서 생성하는 빈 객체를 모두 싱글톤으로 만든다

#### 서버 애플리케이션과 싱글톤

- 왜 스프링은 싱글톤으로 빈을 만들까?
- 주로 스프링이 적용되는 대상이 자바 엔터프라이즈 기술을 사용하는 서버환경
- 스프링이 처음 설계됐던 대규모 엔터프라이즈 서버환경은 서버 하나당 최대로 초당 수십에서 수백 번씩 요청을 받아 처리할 수 있는 성능이 요구되었음
- 그런데 매번 클라이언트에서 요청이 올 때마다 각 로직을 담당하는 객체를 새로 만들면? => 서버가 감당하기 힘듬
- 그래서 엔터프라이즈 분야에서는 <b>서비스 오브젝트</b>라는 개념을 일찍부터 사용해왔음
- 서블릿은 자바 엔터프라이즈 기술의 가장 기본이 되는 서비스 오브젝트라고 할 수 있음


#### 싱글톤 패턴의 한계
  - 자바에서 싱글톤을 구현하는 방법
    1. 클래스 밖에서는 객체를 생성하지 못하도록 생성자를 private으로 만든다
    2. 생성된 싱글톤 객체를 저장할 수 있느 자신과 같은 타입의 스태틱 필드를 정읳나다
    3. 스태틱 팩토리 메소드인 getInstance()를 만들고 메소드가 최초로 호출되는 시점에서 한 번만 객체가 만들어지게 한다. 생성된 객체는 스태틱 필드에 젖아된다.
    4. 한번 객체가 만들어지고 난 후에는 getInstance() 메소드를 통해 이미 만들어져 스태틱 필드에 저장해둔 오브젝트를 넘겨준다
  
  1. private 생성자를 갖고 있기 때문에 상속할 수 없다 => 객체지향적인 설계의 장점을 적용하기 어렵다
  2. 싱글톤은 테스트하기 힘들다 => 테스트에서 사용될 때, 목 객체 등으로 대체하기 힘들다
  3. 서버환경에서는 싱글톤이 하나만 만들어지는 것을 보장하지 못한다 => 여러 개의 JVM에 분산돼서 설치가 되는 경우
  4. 싱글톤의 사용은 전역 상태를 만들 수 있기 때문에 바람직하지 못하다


#### 싱글톤 레지스트리
- 자바의 기본적인 싱글톤 패턴의 구현 방식은 여러 가지 단점이 있음
- 스프링은 직접 싱글톤 형태의 객체를 만들고 관리하는 기능을 제공 => 싱글톤 레지스트리
- 평범한 자바 클래스를 싱글톤으로 활용할 수 있게 해줌 => 
    1. public 생성자를 가질 수 있음 
    2. 테스트 환경에서 자유롭게 객체 생성가능
    3. 목 객체로 대체 가능
  

### 2. 싱글톤과 객체의 상태
- 싱글톤은 멀티스레드 환경이라면 여러 스레드가 동시에 접근해서 사용할 수 있다 => 상태 관리에 주의해야 함
- 상태정보를 내부에 갖고 있지 않은 무상태 방식으로 만들어져야 한다
- 그렇다면 각 요청에 대한 정보나, DB나 서버의 리소스로부터 생성한 정보는 어떻게 다루는가?
- 파라미터와 로컬 변수, 리턴 값을 이용하면 된다.
- 메소드 파라미터나, 메소드 안에서 생성되는 로컬 변수는 매번 새로운 값을 저장할 독립적인 공간이 만들어지므로 싱글톤이라고 해도 여러 스레드가 값을 덮어쓰지 않음


### 3. 스프링 빈의 스코프
- 스프링이 관리하는 객체, 즉 빈이 생성되고, 존재하고, 적용되는 범위 => 빈의 스코프
- 기본 스코프는 싱글톤
- 경우에 따라서는 다른 스코프를 사용할 수 있음. 대표적으로 프로토타입 스코프가 있음.
- 프로토타입은 컨테이너에 빈을 요청할 떄마다 새로운 객체를 만들어줌
- 그 외에도 웹을 통해 새로운 HTTP 요청이 생길때마다 생성되는 요청 스코프
- 웹의 세션과 유사한 세션 스코프가 있음