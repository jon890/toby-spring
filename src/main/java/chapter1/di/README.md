## 7. 의존관계 주입 (di package)

### 1. 제어의 역전(IoC)와 의존관계 주입

- IoC는 매우 느슨하게 정의돼서 폭넓게 사용되는 단어이다
- 때문에 스프링을 IoC 컨테이너라고만 해서는 스프링이 제공하는 기능의 특징을 명확하게 설명하지 못한다
- 때문에 몇몇 사람의 제안으로 스프링이 제공하는 IoC 방식을 의존관계 주입이라는, 좀 더 의도가 명확히 드러나는 이름을 사용하기 시작했다
- 그래서 초기에는 주로 IoC 컨테이너라고 불리던 스프링이 지금은 의존관계 주입 컨테이너 또는 DI 컨테이너라고 더 많이 불리고 있다

<b>[참고]</b>

- DI : 객체 레퍼런스를 외부로 부터 제공(주입)받고 이를 통해 여타 객체와 다이내믹하게 의존관계가 만들어지는 것

### 2. 런타임 의존관계 설정

- 의존하다 : 의존대상이 변하면 그 것에 영향을 미치는 것, 방향성이 있음


- UserDao가 ConnectionMaker에 의존하고 있다
- 따라서 ConnectionMaker 인터페이스가 변한다면 그 영향을 UserDao가 직접적으로 받게 된다
- <b>하지만 ConnectionMaker를 구현한 클래스, PostgreSqlConnectionManager 등이 다른 것으로 바뀌거나 그 내부에서 사용하는 메소드에 변화가 생겨도 UserDao에 영향을 주지
  않는다</b>


- 이렇게 인터페이스에 대해서만 의존관계를 만들어두면 인터페이스의 구현 클래스와의 관계는 느슨해지면서 변화에 영향을 덜 받는 상태가 된다. 즉 결합도가 낮아진다

#### 의존관계 주입 정리

1. 클래스 모델이나 코드에는 런타임 시점의 의존관계가 드러나지 않는다. 그러기 위해서는 인터페이스에만 의존하고 있어야 한다
2. 런타임 시점의 의존관계는 컨테이너나 팩토리 같은 제3의 존재가 결정한다.
3. 의존관계는 사용할 오브젝트에 대한 레퍼런스를 외부에서 제공(주입)해줌으로써 만들어진다. => DaoFactory => IoC/DI 컨테이너


- DI는 자신이 사용할 오브젝트에 대한 선택과 생성 제어권을 외부로 넘기고 자신은 수동적으로 주입받은 오브젝트를 사용한다는 점에서 IoC의 개념에 잘 들어맞는다

### 3. 의존관계 검색과 주입

- 스프링이 제공하는 IoC 방법에는 의존관계 주입만 있는 것이 아니다
- 의존관계 검색이라고 불리는 것도 있다
- 자신이 필요로 하는 의존 오브젝트를 능동적으로 찾는다

        예시 : 의존관계 검색을 이용하는 UserDao 생성자

        public UserDao() {
            AnnotationConfigApplicationContext context =
                new AnnotationConfigApplicationContext(DaoFactory.class);
            this.connectionMaker = context.getBean("connectionMaker", ConnectionMaker.class);
        }

- 의존관계 주입이 훨씬 단순하고 깔끔하다
- 의존관계 검색 방법은 코드 안에 오브젝트 팩토리 클래스나 스프링 API가 나타난다
- 사용자에 대한 DB 정보를 어떻게 가져올 것인가에 집중해야 하는 UserDao에서 스프링이나 오브젝트 팩토리를 만들고 API를 이용하는 코드가 섞여있는 것은 바람직하지 않다


- 사용해야 될때도 있다
- UserDaoTest 테스트 코드에서는 이미 의존관계 검색 방식인 getBean()을 사용했다
- 애플리케이션의 기동시점에서 적어도 한 번은 의존관계 검색 방식을 사용해 오브젝트를 가져와야 한다
- 스태틱 메소드인 main() 에서는 DI를 이용해 오브젝트를 주입 받을 방법이 없기 때문이다

    참고 - DI 받는다
    단지 외부에서 파라미터로 오브젝트를 주입했다고 다 DI는 아니다.
    DI에서 말하는 주입은 다이내믹하게 구현 클래스를 결정해서 제공받을 수 있도록 
    인터페이스 타입의 파라미터를 통해 이뤄져야 한다.

### 4. 의존관계 주입의 응용

1. 기능 구현의 교환
    - 로컬 DB, 운영 DB 변경을 쉽게 =>  
      원하는 DB Connection Manager를 주입해준다
2. 부가기능 추가
    - DAO가 DB를 얼마나 많이 연결해서 사용하는지 파악해보고 싶다고 하자
    - DB 연결횟수를 세는 일은 DAO의 관심사항이 아니다
    - DAO와 DB 커넥션을 만드는 오브젝트 사이에 연결횟수를 카운팅하는 오브젝트를 하나 더 추가! => CountingConnectionMaker 클래스 참고
    - UserDao => CountingConnectionMaker => PostgreSqlConnectionManager
    
  

